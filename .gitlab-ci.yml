image: geerlingguy/drupal-vm
stages:
  - validate
  - build
  - test
  - deploy

variables:
  APP_NAME: joeyspaw 

before_script:
  - apt-get update
  - apt-get install zip unzip
  - php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
  - php composer-setup.php
  - php -r "unlink('composer-setup.php');"
  - php composer.phar install
  - php composer.phar run-script blt-alias
  - source ~/.bash_profile

validate:
  stage: validate
  script:
    - blt validate:all

build:
  stage: build
  script:
    - composer validate --no-check-all --ansi
    - composer install --ansi
    - blt setup:build

test:
  stage: test
  script:
    - blt tests --define tests.run-server=true --yes -v

production:
  stage: deploy
  script:
    - echo "Launching application"
  environment:
    name: production
    url: http://$APP_NAME.stage.bsddigital.com
  only:
    - master
